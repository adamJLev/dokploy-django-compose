services:
  server:
    build: .
    # 1. Gunicorn Configuration
    # Ensure graceful-timeout matches or is slightly less than Docker's stop_grace_period
    command: >
      poetry run gunicorn bananasinc.wsgi:application
      --bind 0.0.0.0:8000
      --workers 3
      --timeout 5
      --graceful-timeout 5
    expose:
      - "8000"
    restart: always

    # 2. Docker Healthcheck (CRITICAL)
    # Traefik will not route traffic to the new container until this passes
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/"]
      interval: 5s
      timeout: 5s
      retries: 3
      start_period: 10s

    # 3. Graceful Shutdown (CRITICAL)
    # Must be longer than Gunicorn's --graceful-timeout (30s)
    # If this is too short, Docker kills the container while it's still finishing requests (504 Error)
    stop_grace_period: 10s

    # 4. Rolling Update Strategy (The Magic)
    deploy:
      mode: replicated
      replicas: 1 # You can increase this to 2 for higher availability
      update_config:
        parallelism: 1
        delay: 5s
        # "start-first" spins up the NEW container and waits for healthcheck
        # BEFORE stopping the old one.
        order: start-first
        failure_action: rollback